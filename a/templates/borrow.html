{% extends 'base.html' %}
{% block content %}
<title>Borrow - Lending Protocol</title>
<header>
  <div class="container">
      <h1>Borrow from Our Lending Protocol</h1>
  </div>
</header>

<div class="container">
  <div class="description">
      <p>Borrow assets using your collateral. Make sure you have sufficient collateral before borrowing.</p>
  </div>
  
  <div class="borrow-form">
      <form id="borrowForm">
          <div class="form-group">
              <label for="borrow_asset">Borrow Asset:</label>
              <select name="borrow_asset" id="borrow_asset">
                  <option value="ETH">ETH</option>
                  <option value="USDC">USDC</option>
                  <option value="USDT">USDT</option>
                  <option value="WBTC">WBTC</option>
              </select>
          </div>
          <div class="form-group">
              <label for="collateral_asset">Collateral Asset:</label>
              <select name="collateral_asset" id="collateral_asset">
                  <option value="ETH">ETH</option>
                  <option value="USDC">USDC</option>
                  <option value="USDT">USDT</option>
                  <option value="WBTC">WBTC</option>
              </select>
          </div>
          <div class="form-group">
              <label for="borrow_amount">Borrow Amount:</label>
              <input type="number" name="borrow_amount" id="borrow_amount" step="0.000001" required>
          </div>
          <button type="submit">Borrow</button>
      </form>
  </div>
  
  <div id="message"></div>
</div>

<script>

  // 如果你要用到 assetAddresses，需要在这里定义或在 base.html 定义
  const assetAddresses = {
      'ETH':  '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',  // 若合约中规定的 ETH "地址"
      'USDC': '0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8',  // 示例
      'USDT': '0xaA8E23Fb1079EA71e0a56F48a2aA51851D8433D0',
      'WBTC': '0x29f2D40B0605204364af54EC677bD022dA425d03'
  };

  document.addEventListener('DOMContentLoaded', () => {
    const borrowForm = document.getElementById('borrowForm');
    const messageDiv = document.getElementById('message');

    borrowForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      messageDiv.textContent = ''; // 清空消息

      const borrowAsset = document.getElementById('borrow_asset').value;
      const collateralAsset = document.getElementById('collateral_asset').value;
      const borrowAmount = document.getElementById('borrow_amount').value;

      // 1. 检查是否已连接钱包
      if (!web3 || !contract || !userAccount) {
        alert('Please connect your wallet first!');
        return;
      }

      try {
        // 2. 获取合约里对应的代币地址
        const borrowAssetAddress     = assetAddresses[borrowAsset];
        const collateralAssetAddress = assetAddresses[collateralAsset];

        // 不同代币的 decimals
        let decimals = 18;
        if (borrowAsset === 'USDC' || borrowAsset === 'USDT') {
          decimals = 6;
        } else if (borrowAsset === 'WBTC') {
          decimals = 8;
        }

        // 3. 转换 borrowAmount => Wei/最小单位
        const weiAmount = web3.utils.toBN(borrowAmount).mul(
          web3.utils.toBN(10).pow(web3.utils.toBN(decimals))
        );

        // 4. 检查抵押品是否需要 approve
        // 如果 collateralAsset 是 ETH，就不需要 balanceOf/approve
        if (collateralAsset !== 'ETH') {
          const collateralContract = new web3.eth.Contract(ERC20_ABI, collateralAssetAddress);
          const balance   = await collateralContract.methods.balanceOf(userAccount).call();
          const allowance = await collateralContract.methods.allowance(userAccount, contractAddress).call();

          // 如果余额不足，抛错
          if (web3.utils.toBN(balance).lt(weiAmount)) {
            throw new Error('Insufficient collateral balance');
          }

          // 如果 allowance 不够，则先 approve
          if (web3.utils.toBN(allowance).lt(weiAmount)) {
            await collateralContract.methods
              .approve(contractAddress, weiAmount)
              .send({ from: userAccount });
          }
        }

        // 5. 估算 gas
        const gasEstimate = await contract.methods
          .borrow(borrowAssetAddress, collateralAssetAddress, weiAmount)
          .estimateGas({ from: userAccount });

        // 6. 发起借款交易
        const txResult = await contract.methods
          .borrow(borrowAssetAddress, collateralAssetAddress, weiAmount)
          .send({
            from: userAccount,
            gas: Math.floor(gasEstimate * 1.2) // 增加 20% buffer
          });

        messageDiv.textContent = `Successfully borrowed ${borrowAmount} ${borrowAsset} using ${collateralAsset} as collateral.\nTx hash: ${txResult.transactionHash}`;

      } catch (error) {
        console.error('Error:', error);
        messageDiv.textContent = 'Error: ' + error.message;
      }
    });
  });
</script>
{% endblock %}

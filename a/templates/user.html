{% extends 'base.html' %}
{% block content %}
<title>User Dashboard - Lending Protocol</title>

<header>
    <div class="container">
        <h1>User Dashboard</h1>
    </div>
</header>

<div class="container">
    <div class="user-deposits">
        <h2>Your Deposits</h2>
        <table>
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Amount</th>
                    <th>Value (USD)</th>
                </tr>
            </thead>
            <tbody id="depositsTable">
                <!-- Dynamically populated -->
            </tbody>
        </table>
    </div>

    <div class="user-borrows">
        <h2>Your Borrows</h2>
        <table>
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Amount</th>
                    <th>Value (USD)</th>
                </tr>
            </thead>
            <tbody id="borrowsTable">
                <!-- Dynamically populated -->
            </tbody>
        </table>
    </div>

    <div class="borrow-availability">
        <h2>Borrow Availability</h2>
        <table>
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Max Borrowable (USD)</th>
                </tr>
            </thead>
            <tbody id="borrowableTable">
                <!-- Dynamically populated -->
            </tbody>
        </table>
    </div>

    <div id="message"></div>

    <button id="refreshData">Refresh Data</button>
</div>

<script>
    // 资产地址映射
    const assetAddresses = {
        'ETH': '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
        'USDC': '0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8',
        'USDT': '0xaA8E23Fb1079EA71e0a56F48a2aA51851D8433D0',
        'WBTC': '0x29f2D40B0605204364af54EC677bD022dA425d03'
    };

    // 动态填充数据的函数
    async function fetchData() {
        const messageDiv = document.getElementById('message');
        const depositsTable = document.getElementById('depositsTable');
        const borrowsTable = document.getElementById('borrowsTable');
        const borrowableTable = document.getElementById('borrowableTable');

        try {
            // 清空提示和表格
            messageDiv.textContent = '';
            depositsTable.innerHTML = '';
            borrowsTable.innerHTML = '';
            borrowableTable.innerHTML = '';

            // 获取用户存款
            for (const [asset, address] of Object.entries(assetAddresses)) {
                const deposit = await contract.methods.userDeposits(address, userAccount).call();
                const value = await contract.methods.getAssetValue(address, deposit.amount).call();

                if (deposit.amount > 0) {
                    depositsTable.innerHTML += `
                        <tr>
                            <td>${asset}</td>
                            <td>${web3.utils.fromWei(deposit.amount)}</td>
                            <td>${(value / 1e8).toFixed(2)}</td>
                        </tr>`;
                }
            }

            // 获取用户借款
            for (const [asset, address] of Object.entries(assetAddresses)) {
                const borrow = await contract.methods.userBorrows(address, userAccount).call();
                const value = await contract.methods.getAssetValue(address, borrow.amount).call();

                if (borrow.amount > 0) {
                    borrowsTable.innerHTML += `
                        <tr>
                            <td>${asset}</td>
                            <td>${web3.utils.fromWei(borrow.amount)}</td>
                            <td>${(value / 1e8).toFixed(2)}</td>
                        </tr>`;
                }
            }

            // 获取可借款额度
            const { 0: maxAmounts, 1: assets } = await contract.methods.getMaxBorrowableAmounts(userAccount).call();
            for (let i = 0; i < assets.length; i++) {
                const asset = Object.keys(assetAddresses).find(key => assetAddresses[key] === assets[i]);
                borrowableTable.innerHTML += `
                    <tr>
                        <td>${asset}</td>
                        <td>${(maxAmounts[i] / 1e8).toFixed(2)}</td>
                    </tr>`;
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            messageDiv.textContent = 'Error: ' + error.message;
        }
    }

    // 页面加载和刷新按钮的事件绑定
    document.addEventListener('DOMContentLoaded', () => {
        if (!userAccount || !contract) {
            document.getElementById('message').textContent = 'Please connect your wallet first!';
            return;
        }
        fetchData();

        // 绑定刷新按钮
        document.getElementById('refreshData').addEventListener('click', fetchData);
    });
</script>

{% endblock %}

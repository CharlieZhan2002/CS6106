{% extends 'base.html' %}
{% block content %}
<title>User Dashboard - Lending Protocol</title>

<header>
    <div class="container">
        <h1>User Dashboard</h1>
    </div>
</header>

<div class="container">
    <div class="user-deposits">
        <h2>Your Deposits</h2>
        <table>
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Amount</th>
                    <th>Value (USD)</th>
                </tr>
            </thead>
            <tbody id="depositsTable">
                <!-- Dynamically populated -->
            </tbody>
        </table>
    </div>

    <div class="user-borrows">
        <h2>Your Borrows</h2>
        <table>
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Amount</th>
                    <th>Value (USD)</th>
                </tr>
            </thead>
            <tbody id="borrowsTable">
                <!-- Dynamically populated -->
            </tbody>
        </table>
    </div>

    <div class="borrow-availability">
        <h2>Borrow Availability</h2>
        <table>
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Max Borrowable (USD)</th>
                </tr>
            </thead>
            <tbody id="borrowableTable">
                <!-- Dynamically populated -->
            </tbody>
        </table>
    </div>

    <div id="message"></div>

    <button id="refreshData">Refresh Data</button>
</div>

<script>
    let activeAssets = [];  // 移動變數宣告至更靠近頂部
    console.log('Active assets:', activeAssets);

    // 资产地址映射
    const assetAddresses = {
        'ETH': '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
        'USDC': '0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8',
        'USDT': '0xaA8E23Fb1079EA71e0a56F48a2aA51851D8433D0',
        'WBTC': '0x29f2D40B0605204364af54EC677bD022dA425d03'
    };

    // **新增資產小數位定義**
    const assetDecimals = {
        'ETH': 18,
        'USDC': 6,
        'USDT': 6,
        'WBTC': 8
    };

    // 頁面載入時檢查 userAccount 和 contract，若已連接錢包則讀取資料
    document.addEventListener('DOMContentLoaded', async () => {
    // 檢查是否連接錢包和合約
    if (!userAccount || !contract) {
        document.getElementById('message').textContent = 'Please connect your wallet first!';
        return;
    }

    try {
        // 嘗試獲取 activeAssets 資料
        activeAssets = await contract.methods.activeAssets().call();
        console.log('Active assets retrieved:', activeAssets);

        // 檢查 activeAssets 是否為空
        if (!activeAssets || activeAssets.length === 0) {
            console.warn('No active assets found.');
            document.getElementById('message').textContent = 'No active assets found!';
            return;
        }

        // 呼叫 fetchUserData 以加載用戶資料
        console.log('Calling fetchUserData');
        await window.fetchUserData();
        console.log('fetchUserData completed');

    } catch (err) {
        console.error('Error fetching active assets:', err);
        document.getElementById('message').textContent = 'Failed to load active assets!';
    }
});

    try {
        // 3. 初始化 activeAssets
        activeAssets = await contract.methods.activeAssets().call();
        console.log('Active assets:', activeAssets);
    } catch (err) {
        console.error('Failed to fetch active assets:', err.message);
        return;
    }

    // 4. 呼叫動態填充數據的函數
    console.log('Calling fetchUserData');
    await window.fetchUserData();
    console.log('fetchUserData completed');

    // 5.动态填充数据的函数
    window.fetchUserData = async function () {

        const messageDiv = document.getElementById('message');
        const depositsTable = document.getElementById('depositsTable');
        const borrowsTable = document.getElementById('borrowsTable');
        const borrowableTable = document.getElementById('borrowableTable');

        messageDiv.textContent = 'Loading data...';
        depositsTable.innerHTML = '';
        borrowsTable.innerHTML = '';
        borrowableTable.innerHTML = '';

        // === 1. 获取用户存款 ===
        activeAssets = activeAssets.map(addr => addr.toLowerCase());

        for (const [assetName, assetAddr] of Object.entries(assetAddresses)) {
            try {
                // 確認 activeAssets 是否包含該資產地址（小寫比較）
                if (!activeAssets.includes(assetAddr.toLowerCase())) {
                    console.warn(`Asset ${assetName} not active. Skipping.`);
                    continue;
                }

                console.log(`Fetching data for active asset: ${assetName}`);

                // 從合約中獲取用戶存款資料
                const deposit = await contract.methods.userDeposits(assetAddr, userAccount).call();
                const priceRaw = await contract.methods.getAssetPrice(assetAddr).call();

                // 計算存款數量與美元價值
                const depositAmountNum = Number(deposit.amount) / (10 ** assetDecimals[assetName]);
                const depositUSD = (Number(priceRaw) * depositAmountNum) / 1e8;

                // 將資料動態插入表格
                depositsTable.innerHTML += `
                    <tr>
                        <td>${assetName}</td>
                        <td>${depositAmountNum.toFixed(6)}</td>
                        <td>${depositUSD.toFixed(2)}</td>
                    </tr>`;
            } catch (err) {
                console.error(`Error fetching data for ${assetName}:`, err);

                // 如果出錯，顯示預設值
                depositsTable.innerHTML += `
                    <tr>
                        <td>${assetName}</td>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>`;
            }
        }


            // === 2. 获取用户借款 ===
        for (const [assetName, assetAddr] of Object.entries(assetAddresses)) {
            try {
                if (!activeAssets.map(addr => addr.toLowerCase()).includes(assetAddr.toLowerCase())) {
                    console.warn(`Asset ${assetName} not active. Skipping.`);
                    continue;
                }

                console.log(`Fetching borrow data for asset: ${assetName}`);

                // 呼叫智能合約方法
                const borrow = await contract.methods.userBorrows(assetAddr, userAccount).call();
                const priceRaw = await contract.methods.getAssetPrice(assetAddr).call();

                // 計算數量與金額
                const borrowAmountNum = Number(borrow.amount) / (10 ** assetDecimals[assetName]);
                const borrowUSD = (Number(priceRaw) * borrowAmountNum) / 1e8;

                // 將數據填入表格
                borrowsTable.innerHTML += `
                    <tr>
                        <td>${assetName}</td>
                        <td>${borrowAmountNum.toFixed(6)}</td>
                        <td>${borrowUSD.toFixed(2)}</td>
                    </tr>`;
            } catch (err) {
                console.error(`Failed to fetch borrow data for ${assetName}:`, err.message);

                // 顯示預設值
                borrowsTable.innerHTML += `
                    <tr>
                        <td>${assetName}</td>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>`;
            }
        }


        // === 3. 获取可借款额度 ===
        for (const [assetName, assetAddr] of Object.entries(assetAddresses)) {
            try {
                if (!activeAssets.map(addr => addr.toLowerCase()).includes(assetAddr.toLowerCase())) {
                    console.warn(`Asset ${assetName} not active. Skipping.`);
                    continue;
                }

                console.log(`Fetching max borrowable data for asset: ${assetName}`);

                // 呼叫智能合約方法，獲取最大可借款額度
                const { 0: maxAmounts, 1: assets } = await contract.methods.getMaxBorrowableAmounts(userAccount).call();

                // 找到對應資產的索引
                const index = assets.map(addr => addr.toLowerCase()).indexOf(assetAddr.toLowerCase());
                if (index === -1) throw new Error('Asset not found in borrowable list');

                // 計算最大可借款金額
                const maxBorrowAmount = Number(maxAmounts[index]);
                const priceRaw = await contract.methods.getAssetPrice(assetAddr).call();
                const borrowableUSD = (Number(priceRaw) * maxBorrowAmount) / (10 ** assetDecimals[assetName]) / 1e8;

                // 填入表格
                borrowableTable.innerHTML += `
                    <tr>
                        <td>${assetName}</td>
                        <td>${maxBorrowAmount.toFixed(6)}</td>
                        <td>${borrowableUSD.toFixed(2)}</td>
                    </tr>`;
            } catch (err) {
                console.error(`Failed to fetch borrow availability for ${assetName}:`, err.message);

                // 顯示預設值
                borrowableTable.innerHTML += `
                    <tr>
                        <td>${assetName}</td>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>`;
            }
        }
    }
</script>
{% endblock %}
